---

title: Data management


keywords: fastai
sidebar: home_sidebar

summary: "Create, from FT1 and FT2, a compact data set with photon and livetime info."
description: "Create, from FT1 and FT2, a compact data set with photon and livetime info."
nb_path: "nbs/01_data_man.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/01_data_man.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Overview">Overview<a class="anchor-link" href="#Overview"> </a></h3><p>Fermi-LAT weekly data files are extracted from the <a href="https://heasarc.gsfc.nasa.gov/FTP/fermi/data/lat/weekly">GSFC FTP server </a>, 
with subfolders for the photon data, <code>photon</code> and spacecraft data, <code>spacecraft</code>. It is <a href="http://fermi.gsfc.nasa.gov/ssc/data/access/http://fermi.gsfc.nasa.gov/ssc/data/access/">described here</a></p>
<p>The class <a href="/wtlikedata_man.html#FermiData"><code>FermiData</code></a> downloads these to temporary files and constructs a dict for each week with
contents</p>
<ul>
<li><p>photons: a table, entry per selected photon with columns, converted with <a href="/wtlikedata_man.html#get_ft1_data"><code>get_ft1_data</code></a></p>
<ul>
<li>run number (uint32, stored as a category by pandas)</li>
<li>time since the run start, in 2 $\mu$s intervals  (uint32)</li>
<li>energy and event type (uint8)</li>
<li>position as HEALPix index (uint32)</li>
</ul>
</li>
<li><p>sc_data: a table, an entry per 30-s interval, with columns, all float32, converted with <a href="/wtlikedata_man.html#get_ft2_info"><code>get_ft2_info</code></a></p>
<ul>
<li>start/stop time </li>
<li>S/C direction </li>
<li>zenith direction</li>
</ul>
</li>
<li>gti_times: an array of interleaved start/stop intervals</li>
<li>file_date: modification date for the FT1 file at GSFC.</li>
</ul>
<p>These dict objects, one per week, are saved in a folder</p>
<h4 id="A-note-about-timing">A note about timing<a class="anchor-link" href="#A-note-about-timing"> </a></h4><p>A run is typically an orbit or less, at most 6 ks. Integerizing the offset from this using 32 bits, one has 5e5 intervals/s, so 
we choose 2$\mu$s.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nbdev.showdoc</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="get_ft1_data" class="doc_header"><code>get_ft1_data</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L21" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>get_ft1_data</code>(<strong><code>config</code></strong>, <strong><code>ft1_file</code></strong>)</p>
</blockquote>
<p>Read in a photon data (FT1) file, bin in energy and position to convert to a compact DataFrame</p>
<ul>
<li><code>ft1_file</code> -- A monthly file generated by J. Ballet, or a weekly file from GSFC</li>
</ul>
<p>Depends on config items</p>
<ul>
<li><code>theta_cut, z_cut</code> -- selection criteria</li>
<li><code>ebins, etypes</code> -- define band index</li>
<li><code>nside, nest</code> -- define HEALPix binning</li>
</ul>
<p>Returns a tuple with</p>
<ul>
<li><p><code>tstart</code>, the start MET time</p>
</li>
<li><p>DataFrame  with columns</p>
<ul>
<li><code>band</code> (uint8):    energy band index*2 + 0,1 for Front/Back</li>
<li><code>nest_index</code>  if nest else <code>ring_index</code> (uint32): HEALPIx index for the nside</li>
<li><code>run_id</code> (uint32) The run number, stored as a categorical uint32 array</li>
<li><code>trun</code> (unit32): time since run the id in 2 $\mu s$ units</li>
</ul>
</li>
<li><p>gti times as an interleaved start, stop array.</p>
</li>
</ul>
<p>For the selected events above 100 MeV, this represents 9 bytes per photon, vs. 27.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="get_ft2_info" class="doc_header"><code>get_ft2_info</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L134" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>get_ft2_info</code>(<strong><code>config</code></strong>, <strong><code>filename</code></strong>, <strong><code>gti</code></strong>=<em><code>&lt;lambda&gt;</code></em>)</p>
</blockquote>
<p>Process a FT2 file, with S/C history data, and return a summary DataFrame</p>
<p>Parameters:</p>
<ul>
<li>config -- verbose, cos_theta_max, z_max</li>
<li>filename -- spacecraft (FT2) file</li>
<li>gti -- GTI object that checkes for allowed intervals, in MJD units</li>
</ul>
<p>Returns: A DataFrame with fields consistent with GTI if specified</p>
<ul>
<li>start, stop -- interval in MJD units</li>
<li>livetime -- sec</li>
<li>ra_scz, dec_scz --spaceraft direction</li>
<li>ra_zenith, dec_zenith -- local zenith</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="filepaths" class="doc_header"><code>filepaths</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L178" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>filepaths</code>(<strong><code>week</code></strong>)</p>
</blockquote>
<p>Returns: A tuple with two elements for the week number, each with two triplets with:
ftp folder, ftp filename, local simple filename</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">filepaths</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>[(&#39;spacecraft&#39;,
  &#39;lat_spacecraft_weekly_w009_p310_v001.fits&#39;,
  &#39;week009_ft2.fits&#39;),
 (&#39;photon&#39;, &#39;lat_photon_weekly_w009_p305_v001.fits&#39;, &#39;week009_ft1.fits&#39;)]</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="FermiData" class="doc_header"><code>class</code> <code>FermiData</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L192" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>FermiData</code>(<strong><code>config</code></strong>=<em><code>None</code></em>) :: <code>dict</code></p>
</blockquote>
<p>Manage the full data set in weekly chunks</p>
<ul>
<li>Checking the current set of files at GSFC</li>
<li>downloading a week at a time to a local tmp</li>
<li>Converting to condensed format and saving to pickled dicts in wtlike_data</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># fd.local_filedate, fd.gsfc_filedate</span>

<span class="c1"># filename = fd.local_files()[-1]</span>
<span class="c1"># with open(filename, &#39;rb&#39;) as imp:</span>
<span class="c1">#     fs= pickle.load(imp)</span>
<span class="c1"># fs.keys()</span>

<span class="c1"># ff = fd.local_files()</span>
<span class="c1"># wk = list(map(lambda f: int(os.path.splitext(f)[0][-3:]), ff))</span>

<span class="c1"># # get gti for weeks</span>
<span class="c1"># tt = []</span>
<span class="c1"># for f in ff:</span>
<span class="c1">#     with open(f, &#39;rb&#39;) as imp:</span>
<span class="c1">#         fs = pickle.load(imp)</span>
<span class="c1">#         gti = fs[&#39;gti_times&#39;]</span>
<span class="c1">#         tt += [gti[0], gti[-1]]</span>

<span class="c1"># uu = MJD(np.array(tt)); uu</span>

<span class="c1"># import matplotlib.pyplot as plt</span>
<span class="c1"># from wtlike.config import first_data, day</span>


<span class="c1"># plt.plot( wk, (uu[0::2]-first_data)/7 -wk+9.7, &#39;.&#39;)</span>


<span class="c1"># ft = lambda t: (t-first_data) / 7 + 9.7</span>
<span class="c1"># ft(54685.15), ft(59464.84)</span>

<span class="c1"># def find_week(self, mjd):</span>
<span class="c1">#     &quot;&quot;&quot; find the week number that contains the MJD &quot;&quot;&quot;</span>
    
<span class="c1">#     # estimate that could be off on boundary -- assume not more than a week</span>
<span class="c1">#     week= int((mjd-first_data) / 7 + 9.7 )</span>
<span class="c1">#     x = self.load_week(week)</span>
<span class="c1">#     # check with actual GTI info</span>
<span class="c1">#     gti = x[&#39;gti_times&#39;]</span>
<span class="c1">#     first, last = MJD(gti[0]), MJD(gti[-1])</span>
<span class="c1">#     if mjd&lt; first: return week-1</span>
<span class="c1">#     elif mjd&gt;last: return week+1</span>

<span class="c1">#     return week</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="FermiData-methods">FermiData methods<a class="anchor-link" href="#FermiData-methods"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="FermiData.download" class="doc_header"><code>FermiData.download</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L245" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>FermiData.download</code>(<strong><code>week</code></strong>)</p>
</blockquote>
<p>Download the given week to the tmp folder</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="FermiData.needs_update" class="doc_header"><code>FermiData.needs_update</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L335" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>FermiData.needs_update</code>(<strong><code>threshold</code></strong>=<em><code>0</code></em>)</p>
</blockquote>
<p>Compare files on disk with the GSFC list and compile list that need to be downloaded</p>
<p>Check the file date of the last one on disk and include it if:</p>

<pre><code>* it short and there is one or more GSFC weeks following it,
* It is the most recent week and is short by more than *threshold* days</code></pre>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="bp">self</span> <span class="o">=</span> <span class="n">FermiData</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_update</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>FermiData: 684 week files at GSFC, from (9, &#39;20180718201101&#39;) to (693, &#39;20210913191258&#39;) [693]
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="FermiData.process" class="doc_header"><code>FermiData.process</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L356" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>FermiData.process</code>(<strong><code>days</code></strong>=<em><code>1</code></em>)</p>
</blockquote>
<p>Download and process all weeks missing or needing an update, if within <code>days</code>
from the present</p>
<p>Return status: True if  anything changed</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="FermiData.check_week" class="doc_header"><code>FermiData.check_week</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L328" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>FermiData.check_week</code>(<strong><code>week</code></strong>)</p>
</blockquote>
<p>Returns True if the local week needs updating</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
<span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">valid</span><span class="p">:</span>
    <span class="bp">self</span> <span class="o">=</span> <span class="n">FermiData</span><span class="p">(</span><span class="n">Config</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">check</span> <span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">needs_update</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n\t</span><span class="s1">week(s) needing update: </span><span class="si">{</span><span class="n">check</span><span class="si">}</span><span class="s1">&#39;</span> <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>FermiData: 684 week files at GSFC, from (9, &#39;20180718201101&#39;) to (693, &#39;20210913191258&#39;) 
	week(s) needing update: []
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="check-the-weekly-files">check the weekly files<a class="anchor-link" href="#check-the-weekly-files"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="check_data" class="doc_header"><code>check_data</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L372" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>check_data</code>(<strong><code>config</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Return: sorted list of files, last week number, number of days in last week</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ret</span> <span class="o">=</span> <span class="n">check_data</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Weekly folder &#34;/home/burnett/wtlike_data/data_files&#34; contains 684 weeks.
	 Last week, # 693, has 2.410 days, ends at UTC 2021-09-11 11:10, filedate 20210911113618
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="update_data" class="doc_header"><code>update_data</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L396" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>update_data</code>(<strong><code>update_threshold</code></strong>=<em><code>1</code></em>, <strong><code>config</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Bring all of the local week data summaries up to date, downloading the missing ones from GSFC.
If the last one is the current week, check to see if needs updating, by comparing file date, in days,
from the last update with the current one at GSFC.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_week_files" class="doc_header"><code>get_week_files</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L405" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_week_files</code>(<strong><code>config</code></strong>, <strong><code>week_range</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Return list of week files</p>
<ul>
<li>week_range [None] -- tuple with inclusive range. If None, get all</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

</div>
 

