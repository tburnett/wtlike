---

title: Data management


keywords: fastai
sidebar: home_sidebar

summary: "Create, from FT1 and FT2, a compact data set with photon and livetime info."
description: "Create, from FT1 and FT2, a compact data set with photon and livetime info."
nb_path: "nbs/01_data_man.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/01_data_man.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Overview">Overview<a class="anchor-link" href="#Overview"> </a></h3><p>Fermi-LAT weekly data files are extracted from the <a href="https://heasarc.gsfc.nasa.gov/FTP/fermi/data/lat/weekly">GSFC FTP server </a>, 
with subfolders for the photon data, <code>photon</code> and spacecraft data, <code>spacecraft</code>. It is <a href="http://fermi.gsfc.nasa.gov/ssc/data/access/http://fermi.gsfc.nasa.gov/ssc/data/access/">described here</a></p>
<p>The class <a href="/wtlikedata_man.html#FermiData"><code>FermiData</code></a> downloads these to temporary files and constructs a dict for each week with
contents</p>
<ul>
<li><p>photons: a table, one entry per selected photon with columns, converted with <a href="/wtlikedata_man.html#get_ft1_data"><code>get_ft1_data</code></a></p>
<ul>
<li><code>run_ref</code> (uint8), index into the <code>runs</code> list</li>
<li>time since the run start, in 2 $\mu$s intervals  (uint32)</li>
<li>energy and event type (uint8)</li>
<li>position as HEALPix index with nside, nest from Config, currently 1024, True (uint32) </li>
</ul>
</li>
<li><p>sc_data: a table, one entry per 30-s interval, with columns, all float32, converted with <a href="/wtlikedata_man.html#get_ft2_info"><code>get_ft2_info</code></a></p>
<ul>
<li>start/stop time </li>
<li>S/C direction </li>
<li>zenith direction</li>
</ul>
</li>
<li>runs list of run numbers</li>
<li>gti_times: an array of interleaved start/stop intervals</li>
<li>file_date: modification date for the FT1 file at GSFC.</li>
</ul>
<p>These dict objects are saved in a folder specfied by <code>Config().datapath</code>. Its contents can be 
checked with <a href="/wtlikedata_man.html#check_data"><code>check_data</code></a>, and updated using <a href="/wtlikedata_man.html#update_data"><code>update_data</code></a>.  The contents of a week can be visually 
inspected with <code>plot_week</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Run-numbers-and-timing">Run numbers and timing<a class="anchor-link" href="#Run-numbers-and-timing"> </a></h4><p>The run number is an integer correspnding to the MET at the start of the run. For a week, with 15 orbits/day, we 
expect ~105 runs. We save a table of the run numbers per week, and use a uint8 index in the photon table.</p>
<p>A run is typically an orbit or less, at most 6 ks. Integerizing the offset from the run start, or the run number, using 32 bits, one has 5e5 intervals/s, so we choose 2$\mu$s. Thus we generate the time for each event from three sources: the 2$\mu$s time offset for the run, the index of the run number into the  runs table, and the runs table itself.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="get_ft1_data" class="doc_header"><code>get_ft1_data</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L19" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>get_ft1_data</code>(<strong><code>config</code></strong>, <strong><code>ft1_file</code></strong>)</p>
</blockquote>
<p>Read in a photon data (FT1) file, bin in energy and position to convert to a compact table</p>
<ul>
<li><code>ft1_file</code> -- A weekly file from GSFC</li>
</ul>
<p>Depends on config items</p>
<ul>
<li><code>theta_cut, z_cut</code> -- selection criteria</li>
<li><code>ebins, etypes</code> -- define band index</li>
<li><code>nside, nest</code> -- define HEALPix binning</li>
</ul>
<p>Returns a dict with keys</p>
<ul>
<li><p><code>tstart</code>, the start MET time from the FT1 header</p>
</li>
<li><p><code>photons</code>: a dict with keys and entries for each selected photon</p>
<ul>
<li><code>band</code> (uint8):    energy band index*2 + 0,1 for Front/Back</li>
<li><code>nest_index</code>  if nest else <code>ring_index</code> (uint32): HEALPIx index for the nside</li>
<li><code>run_ref</code> (uint8) reference to the run number, in the array <code>runs</code></li>
<li><code>trun</code> (unit32): time since the run id in 2 $\mu s$ units</li>
</ul>
</li>
<li><p><code>gti_times</code> -- GTI times as an interleaved start, stop array.</p>
</li>
<li><code>runs</code> -- a list of the run numbers, each a MET time. Expect 109 per week</li>
</ul>
<p>For the selected events above 100 MeV, this represents 10 bytes per photon, vs. 27 in the FT1 data</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="photon_week" class="doc_header"><code>photon_week</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L139" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>photon_week</code>(<strong><code>config</code></strong>, <strong><code>week_dict</code></strong>)</p>
</blockquote>
<p>Return a dict with photon info for the week, with a 'time' field, in MJD reconstructed from
the run_ref and trun fields. The latter removed.</p>
<ul>
<li>week_dict -- standard photon info for the week</li>
<li>config -- used for config.offset_size</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="get_ft2_info" class="doc_header"><code>get_ft2_info</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L157" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>get_ft2_info</code>(<strong><code>config</code></strong>, <strong><code>filename</code></strong>, <strong><code>gti</code></strong>=<em><code>&lt;lambda&gt;</code></em>)</p>
</blockquote>
<p>Process a FT2 file, with S/C history data, and return a summary dict</p>
<p>Parameters:</p>
<ul>
<li>config -- verbose, cos_theta_max, z_max</li>
<li>filename -- spacecraft (FT2) file</li>
<li>gti -- GTI object that checkes for allowed intervals, in MJD units</li>
</ul>
<p>Returns: A dict with fields consistent with GTI if specified</p>
<ul>
<li>start, stop -- interval in MJD units</li>
<li>livetime -- sec</li>
<li>ra_scz, dec_scz --spaceraft direction</li>
<li>ra_zenith, dec_zenith -- local zenith</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary data-open="Hide Code" data-close="Show Code"></summary>
        <summary></summary>
        <div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span> <span class="s1">&#39;Exercise access from GSFC and FT1 data handling&#39;</span><span class="p">)</span>
<span class="n">gd</span> <span class="o">=</span> <span class="n">GSFCweekly</span><span class="p">(</span><span class="n">Config</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>
<span class="k">if</span> <span class="n">gd</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">valid</span><span class="p">:</span>
    <span class="n">ft2</span><span class="p">,</span> <span class="n">ft1</span> <span class="o">=</span> <span class="n">gd</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">get_ft1_data</span><span class="p">(</span><span class="n">gd</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="n">gd</span><span class="o">.</span><span class="n">local_path</span><span class="p">)</span><span class="o">/</span><span class="n">ft1</span><span class="p">);</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Contents of the output dict</span><span class="se">\n</span><span class="s1">&#39;</span>
          <span class="s1">&#39; key      value type&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;  </span><span class="si">{</span><span class="n">k</span><span class="si">:</span><span class="s1">10</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Exercise access from GSFC and FT1 data handling
GSFCweekly: spacecraft/lat_spacecraft_weekly_w741_p310_v001.fits --&gt; week741_ft2.fits
GSFCweekly: photon/lat_photon_weekly_w741_p305_v001.fits --&gt; week741_ft1.fits
FT1: week741_ft1.fits, GTI range 681869208.7-682476252.1:  2,437,830 photons
	Selection E &gt; 100 MeV. theta&lt;66.4 and z&lt;100 remove: 83.62%
FT1 data from file week741_ft1.fits: tstart=681869208 (UTC 2022-08-11) selected 399,240/2,437,830 photons, in 107 runs.
Contents of the output dict
 key      value type
  tstart     float
  photons    dict
  gti_times  ndarray
  runlist    ndarray
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="FermiData" class="doc_header"><code>class</code> <code>FermiData</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L292" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>FermiData</code>(<strong><code>config</code></strong>=<em><code>None</code></em>) :: <a href="/wtlikedata_man.html#GSFCweekly"><code>GSFCweekly</code></a></p>
</blockquote>
<p>Manage the full data set in weekly chunks</p>
<ul>
<li>Checking the current set of files at GSFC</li>
<li>downloading a week at a time to a local tmp</li>
<li>Converting to condensed format and saving to pickled dicts in wtlike_data</li>
</ul>

</div>

</div>

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="GSFCweekly.download" class="doc_header"><code>GSFCweekly.download</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L248" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>GSFCweekly.download</code>(<strong><code>week</code></strong>)</p>
</blockquote>
<p>Download the given week's files to the local folder</p>
<p>week -- the mission week number, starting at 9. If negative, get recent one</p>
<p>return the ft1, ft2 local filenames</p>

</div>

</div>

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="FermiData.needs_update" class="doc_header"><code>FermiData.needs_update</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L407" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>FermiData.needs_update</code>()</p>
</blockquote>
<p>Compare files on disk with the GSFC list and compile list that need to be downloaded</p>
<p>Check the file date of the last one on disk and update it as well if it has a different filedate</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="update_data" class="doc_header"><code>update_data</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L488" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>update_data</code>(<strong><code>config</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Bring all of the local week data summaries up to date, downloading the missing ones from GSFC.
If the last one is the current week, check to see if needs updating, by comparing file date, in days,
from the last update with the current one at GSFC.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="check_data" class="doc_header"><code>check_data</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L474" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>check_data</code>(<strong><code>config</code></strong>=<em><code>None</code></em>, <strong><code>update</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>Print current status, and update if requested</p>

</div>

</div>

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="update_data" class="doc_header"><code>update_data</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L488" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>update_data</code>(<strong><code>config</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Bring all of the local week data summaries up to date, downloading the missing ones from GSFC.
If the last one is the current week, check to see if needs updating, by comparing file date, in days,
from the last update with the current one at GSFC.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># dv = DataView()</span>
<span class="c1"># file = dv.week_files[1]</span>
<span class="c1"># with open(file, &#39;rb&#39;) as inp:</span>
<span class="c1">#     u = pickle.load(inp)</span>
<span class="c1"># # sc = SkyCoord(0,0,unit=&#39;deg&#39;, frame=&#39;galactic&#39;)z</span>
<span class="c1"># sc_data = pd.DataFrame(u[&#39;sc_data&#39;])</span>

<span class="c1"># %time sc_process(Config(verbose=1), sc, sc_data).info()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="DataView" class="doc_header"><code>class</code> <code>DataView</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L527" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>DataView</code>(<strong><code>times</code></strong>:<code>tuple</code>=<em><code>(0, 0)</code></em>, <strong><code>config</code></strong>=<em><code>None</code></em>, <strong><code>nside</code></strong>=<em><code>128</code></em>, <strong><code>bmin</code></strong>=<em><code>0</code></em>)</p>
</blockquote>
<p>Manage various views of the data set</p>

</div>

</div>

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="DataView.count_map" class="doc_header"><code>DataView.count_map</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L565" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>DataView.count_map</code>(<strong><code>nside</code></strong>=<em><code>None</code></em>, <strong><code>bmin</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>all-sky count map</p>
<ul>
<li>nside [64] Project map to this value, from data's 1024</li>
<li>bmin [0] minimum band index (8 for 1 GeV cut)</li>
</ul>
<p>Return a HEALPix counts map, in RING ordering</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

