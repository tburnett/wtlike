---

title: Data management

keywords: fastai
sidebar: home_sidebar

summary: "Create, from FT1 and FT2, a compact data set with photon and livetime info."
description: "Create, from FT1 and FT2, a compact data set with photon and livetime info."
nb_path: "nbs/01_data_man.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/01_data_man.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Overview">Overview<a class="anchor-link" href="#Overview"> </a></h3><p>Fermi-LAT weekly data files are extracted from the <a href="https://heasarc.gsfc.nasa.gov/FTP/fermi/data/lat/weekly">GSFC FTP server </a>, 
with subfolders for the photon data, <code>photon</code> and spacecraft data, <code>spacecraft</code>. It is <a href="http://fermi.gsfc.nasa.gov/ssc/data/access/http://fermi.gsfc.nasa.gov/ssc/data/access/">described here</a></p>
<p>The class <a href="/wtlikedata_man#WeeklyData"><code>WeeklyData</code></a> downloads these to temporary files and constructs a dict for each week with
contents</p>
<ul>
<li>photons: a table, entry per selected photon with columns <ul>
<li>time since the weekly tstart (float32)</li>
<li>energy and event type (uint8)</li>
<li>position as HEALPix index (uint32)</li>
</ul>
</li>
<li>sc_data: a table, an entry per 30-s interval, with columns, all float32<ul>
<li>start/stop time </li>
<li>S/C direction </li>
<li>zenith direction</li>
</ul>
</li>
<li>gti_times: an array of interleaved start/stop intervals</li>
</ul>
<p>These dict objects, one per week, are saved in a folder</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Use-run-number-for-offset-instead-of-week-time">Use run number for offset instead of week time<a class="anchor-link" href="#Use-run-number-for-offset-instead-of-week-time"> </a></h4><p>Save run number (int32) as "sparse array" 
A run is at most 6 ks. If I integerize the offset from this with 32 bits, I have 5e5 intervals/s, 2 us.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="get_ft1_data" class="doc_header"><code>get_ft1_data</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L19" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>get_ft1_data</code>(<strong><code>config</code></strong>, <strong><code>ft1_file</code></strong>)</p>
</blockquote>
<p>Read in a photon data (FT1) file, bin in energy and position to convert to a compact DataFrame</p>
<ul>
<li><code>ft1_file</code> -- A monthly file generated by J. Ballet, or a weekly file from GSFC</li>
</ul>
<p>Depends on config items</p>
<ul>
<li><code>theta_cut, z_cut</code> -- selection criteria</li>
<li><code>ebins, etypes</code> -- define band index</li>
<li><code>nside, nest</code> -- define HEALPix binning</li>
</ul>
<p>Returns a tuple with</p>
<ul>
<li><p><code>tstart</code>, the start MET time</p>
</li>
<li><p>DataFrame  with columns</p>
<ul>
<li><code>band</code> (uint8):    energy band index*2 + 0,1 for Front/Back</li>
<li><code>nest_index</code>  if nest else <code>ring_index</code> (uint32): HEALPIx index for the nside</li>
<li><code>run_diff</code>   Run number difference from previous entry. (Saved as spase arary)</li>
<li><code>time</code> (float32):    the elapsed time in s from header value TSTART in the FT1 file</li>
<li><code>rtime</code> (float32): MET time relative to run id.</li>
</ul>
</li>
<li><p>gti times as an interleaved start, stop array.</p>
</li>
</ul>
<p>For the selected events above 100 MeV, this represents 9 bytes per photon, vs. 27.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="get_ft2_info" class="doc_header"><code>get_ft2_info</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L133" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>get_ft2_info</code>(<strong><code>config</code></strong>, <strong><code>filename</code></strong>, <strong><code>gti</code></strong>=<em><code>'&lt;lambda&gt;'</code></em>)</p>
</blockquote>
<p>Process a FT2 file, with S/C history data, and return a summary DataFrame</p>
<p>Parameters:</p>
<ul>
<li>config -- verbose, cos_theta_max, z_max</li>
<li>filename -- spacecraft (FT2) file</li>
<li>gti -- GTI object that checkes for allowed intervals, in MJD units</li>
</ul>
<p>Returns: A DataFrame with fields consistent with GTI if specified</p>
<ul>
<li>start, stop -- interval in MJD units</li>
<li>livetime -- sec</li>
<li>ra_scz, dec_scz --spaceraft direction</li>
<li>ra_zenith, dec_zenith -- local zenith</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># filename =Path(&#39;/tmp/from_gsfc/week668_ft2.fits&#39;)</span>
<span class="c1"># if os.path.exists(filename):</span>
<span class="c1">#     config = Config()</span>
<span class="c1">#     config.verbose=3</span>
<span class="c1">#     t = get_ft2_info(config, filename); </span>
<span class="c1">#     print(t.head())</span>
<span class="c1"># else:</span>
<span class="c1">#     print(f&#39;File {filename} does not exist, skipping get_ft2_info test&#39;)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="WeeklyData" class="doc_header"><code>class</code> <code>WeeklyData</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L177" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>WeeklyData</code>(<strong><code>config</code></strong>, <strong><code>week</code></strong>, <strong><code>overwrite</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>Download and process weekly Fermi-LAT files from GSFC,</p>
<p>at FTP '<a href="https://heasarc.gsfc.nasa.gov/FTP/fermi/data/lat/weekly">https://heasarc.gsfc.nasa.gov/FTP/fermi/data/lat/weekly</a>'</p>
<ul>
<li>week: a mission week number</li>
<li>saveto: path to save the files</li>
</ul>
<p>Creates a pickled file as  dict with</p>
<ul>
<li>tstart--start time (MJD)</li>
<li>photons -- DataFrame with photon data--see <a href="/wtlikedata_man#get_ft1_data"><code>get_ft1_data</code></a></li>
<li>sc_data -- DataFrame with Spacecraft data--see <a href="/wtlikedata_man#get_ft2_info"><code>get_ft2_info</code></a></li>
<li>gti_times -- array of interleaved start/stop times from the photon data</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="check-the-weekly-files">check the weekly files<a class="anchor-link" href="#check-the-weekly-files"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="data_check" class="doc_header"><code>data_check</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L263" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>data_check</code>(<strong><code>config</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Return: list of files, last week number, number of days in last week</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="check_data" class="doc_header"><code>check_data</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L285" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>check_data</code>(<strong><code>config</code></strong>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="update_recent" class="doc_header"><code>update_recent</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L289" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>update_recent</code>(<strong><code>config</code></strong>=<em><code>None</code></em>, <strong><code>test</code></strong>=<em><code>False</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#check_data();</span>
<span class="c1">#update_recent();</span>
<span class="c1">#WeeklyData(Config(), 680, overwrite=True).save()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Weekly folder &#34;/home/burnett/wtlike_data/data_files&#34; contains 673 weeks.
	 Last week, # 682, has 2.354 days, ends at UTC 2021-06-26 08:51
Will reload week 682 ...
</pre>
</div>
</div>

<div class="output_area">

<div class="output_subarea output_text output_error">
<pre>
<span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">ModuleNotFoundError</span>                       Traceback (most recent call last)
<span class="ansi-green-fg">&lt;ipython-input-15-4a41ea90a229&gt;</span> in <span class="ansi-cyan-fg">&lt;module&gt;</span>
<span class="ansi-green-intense-fg ansi-bold">      1</span> <span class="ansi-red-fg"># #hide</span>
<span class="ansi-green-intense-fg ansi-bold">      2</span> <span class="ansi-red-fg">#check_data();</span>
<span class="ansi-green-fg">----&gt; 3</span><span class="ansi-red-fg"> </span>update_recent<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">;</span>
<span class="ansi-green-intense-fg ansi-bold">      4</span> <span class="ansi-red-fg">#WeeklyData(Config(), 680, overwrite=True).save()</span>

<span class="ansi-green-fg">&lt;ipython-input-12-3ee06edaccdf&gt;</span> in <span class="ansi-cyan-fg">update_recent</span><span class="ansi-blue-fg">(config, test)</span>
<span class="ansi-green-intense-fg ansi-bold">     10</span>         print<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">f&#39;Will load next week, # {last_wk+1} ...&#39;</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     11</span>     <span class="ansi-green-fg">if</span> <span class="ansi-green-fg">not</span> test<span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">---&gt; 12</span><span class="ansi-red-fg">         </span>WeeklyData<span class="ansi-blue-fg">(</span>config<span class="ansi-blue-fg">,</span> wk<span class="ansi-blue-fg">,</span> overwrite<span class="ansi-blue-fg">=</span><span class="ansi-green-fg">True</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">.</span>save<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     13</span>         _<span class="ansi-blue-fg">,</span>last_wk<span class="ansi-blue-fg">,</span> new_days <span class="ansi-blue-fg">=</span> data_check<span class="ansi-blue-fg">(</span>config<span class="ansi-blue-fg">)</span>
<span class="ansi-green-intense-fg ansi-bold">     14</span>         <span class="ansi-red-fg">#print(f&#39;Now {days}&#39;)</span>

<span class="ansi-green-fg">&lt;ipython-input-9-5bd13a61d531&gt;</span> in <span class="ansi-cyan-fg">__init__</span><span class="ansi-blue-fg">(self, config, week, overwrite)</span>
<span class="ansi-green-intense-fg ansi-bold">     25</span> 
<span class="ansi-green-intense-fg ansi-bold">     26</span>         &#34;&#34;&#34;
<span class="ansi-green-fg">---&gt; 27</span><span class="ansi-red-fg">         </span><span class="ansi-green-fg">import</span> wget
<span class="ansi-green-intense-fg ansi-bold">     28</span>         self<span class="ansi-blue-fg">.</span>config<span class="ansi-blue-fg">=</span> config
<span class="ansi-green-intense-fg ansi-bold">     29</span>         self<span class="ansi-blue-fg">.</span>saveto<span class="ansi-blue-fg">=</span>Path<span class="ansi-blue-fg">(</span>config<span class="ansi-blue-fg">.</span>wtlike_data<span class="ansi-blue-fg">/</span><span class="ansi-blue-fg">&#39;data_files&#39;</span><span class="ansi-blue-fg">)</span>

<span class="ansi-red-fg">ModuleNotFoundError</span>: No module named &#39;wget&#39;</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_data_files" class="doc_header"><code>get_data_files</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L308" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_data_files</code>(<strong><code>config</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Return a list of the pickled data files</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="load_weeks" class="doc_header"><code>load_weeks</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L331" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>load_weeks</code>(<strong><code>week_range</code></strong>, <strong><code>config</code></strong>=<em><code>None</code></em>, <strong><code>overwrite</code></strong>=<em><code>True</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># weeks = range(678,682)</span>
<span class="c1"># wd=[]</span>
<span class="c1"># for wk in weeks:</span>
<span class="c1"># #     t = WeeklyData(config, week=wk); t.save()</span>
<span class="c1">#     wd.append(t)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#     pixels = wd[week-678].photon_data.nest_index.values</span>
<span class="c1">#     import healpy</span>
<span class="c1">#     l,b = healpy.pix2ang(nside=1024, ipix=pixels, nest=True,lonlat=True)</span>
<span class="c1">#     l[l&gt;180]-=360</span>
<span class="c1">#     sinb = np.sin(np.radians(b))</span>
<span class="c1">#     ax.set(xlim=(180,-180), ylim=(-1,1), xlabel=&#39;$l$&#39;, ylabel=r&#39;$\mathrm{\sin(b)}$&#39;,</span>
<span class="c1">#           title=f&#39;week {week}&#39;)</span>
<span class="c1">#     u = ax.hexbin(l,sinb, bins=&#39;log&#39;);</span>
<span class="c1">#     #plt.colorbar(u);</span>
<span class="c1"># fig, axx = plt.subplots(2,2, figsize=(12,8), sharex=True, sharey=True);</span>
<span class="c1"># plt.subplots_adjust(hspace=0.2, wspace=0.15)</span>
<span class="c1"># for ax, week in zip(axx.flatten(), range(678,682)):</span>
<span class="c1">#     plot_data(ax, week)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#     sc = wd[week-678].sc_data</span>
<span class="c1">#     ra=sc.ra_scz.values</span>
<span class="c1">#     ra[ra&gt;180]-=360</span>
<span class="c1">#     dec=sc.dec_scz.values</span>
<span class="c1">#     fig, ax = plt.subplots() if ax is None else (ax.figure, ax)</span>
<span class="c1">#     ax.plot(ra, dec, &#39;.&#39;);</span>
<span class="c1">#     ax.plot(-94, -29, &#39;+r&#39;, ms=20)</span>
<span class="c1">#     ax.set(xlim=(180,-180), ylim=(-90,90), xlabel=&#39;RA&#39;, ylabel=&#39;Dec&#39;, title=f&#39;week {week}&#39;)</span>
<span class="c1"># fig, axx = plt.subplots(2,2, figsize=(12,8), sharex=True, sharey=True)</span>
<span class="c1"># fig.suptitle(&#39;Fermi pointing&#39;)</span>
<span class="c1"># plt.subplots_adjust(hspace=0.2, wspace=0.15)</span>
<span class="c1"># for ax, week in zip(axx.flatten(), range(678,682)):</span>
<span class="c1">#     plot_scz(week, ax)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

