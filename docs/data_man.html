---

title: Data management

keywords: fastai
sidebar: home_sidebar

summary: "Create, from FT1 and FT2, a compact data set with photon and livetime info."
description: "Create, from FT1 and FT2, a compact data set with photon and livetime info."
nb_path: "nbs/01_data_man.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/01_data_man.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Overview">Overview<a class="anchor-link" href="#Overview"> </a></h3><p>Fermi-LAT weekly data files are extracted from the <a href="https://heasarc.gsfc.nasa.gov/FTP/fermi/data/lat/weekly">GSFC FTP server </a>, 
with subfolders for the photon data, <code>photon</code> and spacecraft data, <code>spacecraft</code>. It is <a href="http://fermi.gsfc.nasa.gov/ssc/data/access/http://fermi.gsfc.nasa.gov/ssc/data/access/">described here</a></p>
<p>The class <a href="wtlike/data_man#WeeklyData"><code>WeeklyData</code></a> downloads these to temporary files and constructs a dict for each week with
contents</p>
<ul>
<li>tstart: reference time</li>
<li>photons: a table, entry per selected photon with columns <ul>
<li>time since tstart</li>
<li>energy and event type</li>
<li>position as HEALPix index</li>
</ul>
</li>
<li>sc_data: a table, an entry per 30-s interval, with columns<ul>
<li>start/stop time</li>
<li>S/C direction</li>
</ul>
</li>
<li>gti_times: an array of interleaved start/stop intervals</li>
</ul>
<p>These dict objects, one per week, are saved in a folder.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="get_ft1_data" class="doc_header"><code>get_ft1_data</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L18" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>get_ft1_data</code>(<strong><code>config</code></strong>, <strong><code>ft1_file</code></strong>)</p>
</blockquote>
<p>Read in a photon data (FT1) file, bin in energy and position to convert to a compact DataFrame</p>
<ul>
<li><code>ft1_file</code> -- A monthly file generated by J. Ballet, or a weekly file from GSFC</li>
</ul>
<p>Depends on config items</p>
<ul>
<li><code>theta_cut, z_cut</code> -- selection criteria</li>
<li><code>ebins, etypes</code> -- define band index</li>
<li><code>nside, nest</code> -- define HEALPix binning</li>
</ul>
<p>Returns a tuple with</p>
<ul>
<li><p><code>tstart</code>, the start MET time</p>
</li>
<li><p>DataFrame  with columns</p>
<ul>
<li><code>band</code> (uint8):    energy band index*2 + 0,1 for Front/Back</li>
<li><code>nest_index</code>  if nest else <code>ring_index</code> (uint32): HEALPIx index for the nside</li>
<li><code>run_diff</code>   Run number difference from previous entry. (Saved as spase arary)</li>
<li><code>time</code> (float32):    the elapsed time in s from header value TSTART in the FT1 file</li>
<li><code>rtime</code> (float32): MET time relative to run id.</li>
</ul>
</li>
<li><p>gti times as an interleaved start, stop array.</p>
</li>
</ul>
<p>For the selected events above 100 MeV, this represents 9 bytes per photon, vs. 27.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="get_ft2_info" class="doc_header"><code>get_ft2_info</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L136" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>get_ft2_info</code>(<strong><code>config</code></strong>, <strong><code>filename</code></strong>, <strong><code>gti</code></strong>=<em><code>'&lt;lambda&gt;'</code></em>)</p>
</blockquote>
<p>Process a FT2 file, with S/C history data, and return a summary DataFrame</p>
<p>Parameters:</p>
<ul>
<li>config -- verbose, cos_theta_max, z_max</li>
<li>filename -- spacecraft (FT2) file</li>
<li>gti -- GTI object that checkes for allowed intervals, in MJD units</li>
</ul>
<p>Returns: A DataFrame with fields consistent with GTI if specified</p>
<ul>
<li>start, stop -- interval in MJD units</li>
<li>livetime -- sec</li>
<li>ra_scz, dec_scz --spaceraft direction</li>
<li>ra_zenith, dec_zenith -- local zenith</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># filename =Path(&#39;/tmp/from_gsfc/week668_ft2.fits&#39;)</span>
<span class="c1"># if os.path.exists(filename):</span>
<span class="c1">#     config = Config()</span>
<span class="c1">#     config.verbose=3</span>
<span class="c1">#     t = get_ft2_info(config, filename); </span>
<span class="c1">#     print(t.head())</span>
<span class="c1"># else:</span>
<span class="c1">#     print(f&#39;File {filename} does not exist, skipping get_ft2_info test&#39;)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="WeeklyData" class="doc_header"><code>class</code> <code>WeeklyData</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L180" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>WeeklyData</code>(<strong><code>config</code></strong>, <strong><code>week</code></strong>, <strong><code>saveto</code></strong>, <strong><code>overwrite</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>Download and process weekly Fermi-LAT files from GSFC,</p>
<p>at FTP '<a href="https://heasarc.gsfc.nasa.gov/FTP/fermi/data/lat/weekly">https://heasarc.gsfc.nasa.gov/FTP/fermi/data/lat/weekly</a>'</p>
<ul>
<li>week: a mission week number</li>
<li>saveto: path to save the files</li>
</ul>
<p>Creates a pickled file as  dict with</p>
<ul>
<li>tstart--start time (MJD)</li>
<li>photons -- DataFrame with photon data--see <a href="wtlike/data_man#get_ft1_data"><code>get_ft1_data</code></a></li>
<li>sc_data -- DataFrame with Spacecraft data--see <a href="wtlike/data_man#get_ft2_info"><code>get_ft2_info</code></a></li>
<li>gti_times -- array of interleaved start/stop times from the photon data</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="check-the-weekly-files">check the weekly files<a class="anchor-link" href="#check-the-weekly-files"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_data_files" class="doc_header"><code>get_data_files</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L260" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_data_files</code>(<strong><code>config</code></strong>)</p>
</blockquote>
<p>Return a list of the pickled data files</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="GTI" class="doc_header"><code>class</code> <code>GTI</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/data_man.py#L278" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>GTI</code>(<strong><code>gti_times</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># class MonthlyData(object):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     monthly_path =&#39;/mnt/c/users/thbur/tmp/monthly&#39;</span>
<span class="c1">#     ft1_pattern = &#39;ft2_20*.fits&#39;</span>
<span class="c1">#     ft2_pattern = &#39;P305_Source_*_zmax105.fits&#39;</span>
    
<span class="c1">#     def __init__(self, config, saveto):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         from pathlib import Path</span>
<span class="c1">#         self.config=config</span>
<span class="c1">#         folder = Path(self.monthly_path)</span>
<span class="c1">#         assert folder.is_dir, f&#39;Monthy folder {self.montly_path} not a folder&#39;</span>
        
<span class="c1">#         self.saveto=Path(saveto)</span>
<span class="c1">#         assert self.saveto.is_dir, f&#39;Output folder {self.saveto} is not a folder.&#39;</span>
<span class="c1">#         os.makedirs(saveto, exist_ok=True)</span>
<span class="c1">#         self.ft2_files = sorted(folder.glob(self.ft1_pattern))</span>
<span class="c1">#         self.ft1_files = sorted(folder.glob(self.ft2_pattern))</span>
<span class="c1">#         print(f&#39;MonthlyData initialized with {len(self.ft1_files)} monthly FT1&#39;\</span>
<span class="c1">#               f&#39; and {len(self.ft2_files)} yearly FT2 files &#39;\</span>
<span class="c1">#              f&#39;\n Saving to {saveto}&#39;)</span>

<span class="c1">#     def process(self, month):</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         month: month index (1..12)</span>
<span class="c1">#         &quot;&quot;&quot;</span>
<span class="c1">#         m = month-1</span>
<span class="c1">#         y = (m+7)//12 # wired-in: data started in August 2008</span>
<span class="c1">#         f1, f2 = self.ft1_files[m], self.ft2_files[y]</span>
<span class="c1">#         assert f1.is_file(), f&#39;FT1 file {f1} not found&#39;</span>
<span class="c1">#         assert f2.is_file(), f&#39;FT2 files {f2} not found&#39;</span>
<span class="c1">#         tstart, p_df, gti_times = get_ft1_data(config, f1) </span>
<span class="c1">#         ft2_df = get_ft2_info(config, f2, gti=GTI(gti_times))</span>
<span class="c1">#         d = dict(tstart = tstart,</span>
<span class="c1">#             photons = p_df,</span>
<span class="c1">#             sc_data = ft2_df,</span>
<span class="c1">#             gti_times = gti_times)</span>
        
<span class="c1">#         filename = self.saveto/f&#39;month_{month:04d}.pkl&#39;</span>
<span class="c1">#         pickle.dump(d, open(filename, &#39;wb&#39;))</span>
<span class="c1">#         if self.config.verbose&gt;0:</span>
<span class="c1">#             print(f&#39;Saved to {filename.name}&#39;)</span>
<span class="c1">#         return d</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># %%capture cap</span>
<span class="c1"># for m in range(1,152 ):</span>
<span class="c1">#     md.process(m)</span>

<span class="c1"># md.process(152)</span>

<span class="c1"># from pathlib import Path</span>
<span class="c1"># folder = Path(&#39;/mnt/c/users/thbur/tmp/monthly&#39;)</span>
<span class="c1"># ft2 = sorted(folder.glob(&#39;ft2_20*.fits&#39;)); ft2</span>
<span class="c1"># ft1 = sorted(folder.glob(&#39;P305_Source_*_zmax105.fits&#39;))</span>
<span class="c1"># len(ft2), len(ft1)</span>

<span class="c1"># %%time</span>
<span class="c1"># dd = []</span>
<span class="c1"># for m in range(12):</span>
<span class="c1">#     dd.append( process(m))</span>

<span class="c1"># year_sel = lambda month: (month+7)//12</span>
<span class="c1"># list(map( year_sel, range(12)))</span>

<span class="c1"># ft2[0].header[&#39;TSTART&#39;]</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nbdev.export</span> <span class="kn">import</span> <span class="n">notebook2script</span>
<span class="n">notebook2script</span><span class="p">()</span>
<span class="o">!</span>date
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Converted 00_config.ipynb.
Converted 01_data_man.ipynb.
Converted 01_effective_area.ipynb.
Converted 02_gti.ipynb.
Converted 02_source_data.ipynb.
Converted 03_exposure.ipynb.
Converted 04_photon_data.ipynb.
Converted 05_weights.ipynb.
Converted 06_poisson.ipynb.
Converted 07_cell_data.ipynb.
Converted 07_cells.ipynb.
Converted 08_loglike.ipynb.
Converted 09_lightcurve.ipynb.
Converted 10_simulation.ipynb.
Converted 14_bayesian.ipynb.
Converted index.ipynb.
Thu Apr 22 06:55:47 PDT 2021
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

