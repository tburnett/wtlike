---

title: Manage cell data


keywords: fastai
sidebar: home_sidebar

summary: "Create cells from source data and define the likelihood"
description: "Create cells from source data and define the likelihood"
nb_path: "nbs/08_cell_data.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/08_cell_data.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Creating-and-fitting-cells">Creating and fitting cells<a class="anchor-link" href="#Creating-and-fitting-cells"> </a></h2><p>As set out in Kerr, we create "cells" by binning in time to form light curves. For each cell, we determine its likelihood function, which is then optimized to estimate the relative signal rate for that duration.</p>
<p>Eqn. 2 of Kerr presents the log likelihood as a function of the incremental relative flux $\alpha$ (with $\beta=0$). The log likelihood for a cell,</p>
<p>{% raw %}
$$ \displaystyle\log\mathcal{L}(\alpha)\ = \sum_w  \log \big( 1 + \alpha\ w \big) - \alpha\ S \tag{1}  $$
{% endraw %}</p>
<p>The sum is over the photon weights $w$ for that cell, and $S$ is the expected value for sum of weights, determined from the total sum and the fraction of the energy-weighted exposure for the cell:</p>
<p>{% raw %}
$$ S =  \frac{f_{cell}}{ f_{total}}\ \sum{w},  $$
{% endraw %}
where $f$ represents the energy-weighted exposure.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><em>Fermi</em> data is broken into distinct <em>runs</em>, corresponding at most to a single orbit. The effective area, or $\frac{df}{dt}$, which varies by a factor of 2 or 3 for each 90-min orbit, is typically  $ 3 000\ \mathrm{cm}^2$, or $0.3\ \mathrm{m^2}$. This is measured in 30-s intervals. Exposure is the sum, for each interval in contained in the cell, of the effective area times livetime in the direcion of the source. Since it depends on energy, the Kerr strategy is to perform a weighted average with a spectrum. This can be improved on, see below.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The value of $\alpha$,  $\hat{\alpha}$, which maximizes the likelihood for the cell is the solution to</p>
<p>{% raw %}
$$ \sum_{w} \frac{w}{1+\hat{\alpha}\ w} = S $$
{% endraw %}</p>
<p>So that $\hat{\alpha}=0$ corresponds to $\sum w=  S$, as expected if the cell's flux is the same as the average.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The Hessian, or inverse variance, is<br>
$$ -\frac{d^2\ \log(\mathcal{L})}{d\ \alpha^2} = \sum_{w} \frac{w^2}{(1+\hat{\alpha}\ w)^2}$$</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Approximate-the-log-if-$%5Calpha-%5Ctimes-%5Comega$-is-small">Approximate the log if $\alpha \times \omega$ is small<a class="anchor-link" href="#Approximate-the-log-if-$%5Calpha-%5Ctimes-%5Comega$-is-small"> </a></h3><p>Kerr uses this to for the frequency derivation. Let $W_=\sum w$ and $U=\sum w^2$. Then the  cell's likelihood is</p>
<p>{% raw %}
$$ \displaystyle\log\mathcal{L}(\alpha)\ \approx   \alpha\ \ (W-S) - \tfrac{1}{2} \alpha^2\ U ,  \tag{2}$$
{% endraw %}</p>
<p>and the maximum likelihood solution is analytic: $\hat{\alpha} =  (W-S)/U$
and the inverse variance simply $U$.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Accounting-for-spectral-dependence">Accounting for spectral dependence<a class="anchor-link" href="#Accounting-for-spectral-dependence"> </a></h3><p>The development above does not consider energy. The sum over weights includes all photons of all energies, and the coresponding exposure uses a weighted average of the energy-dependent effective area. The Kerr 
application uses a power-law spectral shape for this--since we have the actual spectrum available, we can use it instead.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We bin energy into four bands per decade. This modification breaks up a call into eight sub-cells with the
same $\alpha$ value.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Also, the development above determines the <em>count</em> flux per cell, that is, simply counting photons.  An improvement wmeasures the energy flux as well, or perhaps a spectral index factor as a factor for the assumed spectrum.</p>
<p>Each photon has a <em>band</em> index, indicating its type as Front or Back, and its energy band, one of 16 from 100 MeV to 1 TeV. (Although we only use 8 bands, up to 10 GeV). To use this information, we need the corresponding exposure.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Currently the <a href="/wtlikeexposure.html"><code>exposure</code></a> DataFrame has, for each 30-s time interval, the exposure as calculated for the assumed spectrum. This is extended to provide the exposure per energy band.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let $l$ be the energy index. It represents a logarithmic derivative of the energy. Replace $\alpha$ with $\alpha+\zeta l$ in Equ. (2): Then the solution for $\zeta$ is</p>
<p>{% raw %}
$$\zeta = \frac{\sum_l(W_l-S_l-\alpha U_l)}{\sum_l l U_l} $$
{% endraw %}</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Implementation">Implementation<a class="anchor-link" href="#Implementation"> </a></h2><p>The class <a href="/wtlikecell_data.html#CellData"><code>CellData</code></a> is created with the list of photons and exposure history for the source. It is created with 
a <code>time_bins</code> argument to describe the binning, generating a list, accessible via the property <code>cells</code> with the cell information needed to calculate the likelihood function.</p>
<p>Its <code>view</code> member function is used to create a new binning, by making a copy of the <a href="/wtlikecell_data.html#CellData"><code>CellData</code></a> object with the new binning.</p>
<p>The default binning is sequential, with start, stop, and step values. Units for start and stop are MJD, so step is in days. The conventions for interpeting the three numbers (0,0,7), the default, is all weeks from the start of data taking. This is implemented by the function <a href="/wtlikecell_data.html#time_bin_edges"><code>time_bin_edges</code></a>.</p>
<p>The function <a href="/wtlikecell_data.html#partition_cells"><code>partition_cells</code></a> is used to create a set of unequal-sized cells from a BB partition.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Special-phased-bins">Special phased bins<a class="anchor-link" href="#Special-phased-bins"> </a></h4><p>To study long-term, many days, variations in the flux, perhaps due to systematics in the exposure, we implement a folded binning version, specified by start, period, and number of cells.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="time_bin_edges" class="doc_header"><code>time_bin_edges</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/cell_data.py#L18" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>time_bin_edges</code>(<strong><code>config</code></strong>, <strong><code>exposure</code></strong>, <strong><code>tbin</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Return an interleaved array of time bin, or cell start/stop values</p>
<ul>
<li>exposure -- the weighted exposure table derived from the spacecraft info and the source. Used only
  to establish nominal start/stop</li>
<li><p>tbin: an array (a,b,d), default config.time_bins to specify binning</p>
<p>interpretation of a, b, d:</p>
<p>a:  if &gt; 50000, interpret as MJD for start</p>

<pre><code>  if &lt; 0, back from stop
  otherwise, offset from exposure start

</code></pre>
<p>b:  if &gt; 50000, interpret MJD value for stop</p>

<pre><code>  if &gt; 0, increment from start
  otherwise, offset from exposure stop

</code></pre>
<p>d : if positive, the day bin size</p>

<pre><code>  if 0; return contiguous bins</code></pre>
</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="contiguous_bins" class="doc_header"><code>contiguous_bins</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/cell_data.py#L70" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>contiguous_bins</code>(<strong><code>exposure</code></strong>, <strong><code>min_gap</code></strong>=<em><code>20</code></em>, <strong><code>min_duration</code></strong>=<em><code>600</code></em>)</p>
</blockquote>
<p>return a start/stop interleaved array for contiguous intervals</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="CellData" class="doc_header"><code>class</code> <code>CellData</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/cell_data.py#L102" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>CellData</code>(<strong>*<code>pars</code></strong>, <strong>**<code>kwargs</code></strong>) :: <a href="/wtlikesource_data.html#SourceData"><code>SourceData</code></a></p>
</blockquote>
<p>Manage a set of cells generated from a data set</p>
<p>Invoke superclass to load photon data and exposure for the source.</p>
<ul>
<li>time_bins, default config.time_bins</li>
</ul>
<p>The <code>e</code> cell entry is the weighted exposure for the cell in units $cm^2\ Ms$.</p>

</div>

</div>

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="CellData.view" class="doc_header"><code>CellData.view</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/cell_data.py#L208" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>CellData.view</code>(<strong>*<code>pars</code></strong>, <strong><code>exp_min</code></strong>=<em><code>None</code></em>, <strong><code>no_update</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>Return a "view", a copy of this instance with a perhaps a different set of cells</p>
<ul>
<li><p>pars -- start, stop, step  to define new binning. Or start, step, or just step
 start and stop are either MJD values, or offsets from the start or stop.
 step -- the cell size in days, or if zero, orbit-based binning</p>
</li>
<li><p>exp_min [None] -- If specified, a different minimum exposure, in cm^2 Ms units to use for fitting
  from.</p>
</li>
<li><p>no_update -- avoid fitting the cells if invoked by LightCurve or WtLike</p>
</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="concatenate_cells" class="doc_header"><code>concatenate_cells</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/cell_data.py#L353" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>concatenate_cells</code>(<strong><code>cells</code></strong>)</p>
</blockquote>
<p>Combine a group of cells to one</p>
<ul>
<li>cells: dataframe with cells containing  n, w, S, B<br>
<pre><code>  Optionally, if $t$ is present, generate t and tw
</code></pre>
Return a dict with summed n, S, B, and concatenated w</li>
</ul>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="partition_cells" class="doc_header"><code>partition_cells</code><a href="https://github.com/tburnett/wtlike/tree/master/wtlike/cell_data.py#L371" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>partition_cells</code>(<strong><code>config</code></strong>, <strong><code>cells</code></strong>, <strong><code>edges</code></strong>)</p>
</blockquote>
<p>Partition a set of cells</p>
<ul>
<li>cells -- A DataFrame of cells</li>
<li>edges  -- a list of edge times delimiting boundaries between cells</li>
</ul>
<p>Returns a DataFrame of combined cells, with times and widths adjusted to account for missing cells</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary data-open="Hide Code" data-close="Show Code"></summary>
        <summary></summary>
        <div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">cells</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># global CellData object used below</span>

<span class="nd">@ipynb_doc</span>
<span class="k">def</span> <span class="nf">load_cell_data</span><span class="p">(</span><span class="n">source_name</span><span class="o">=</span><span class="s1">&#39;Geminga&#39;</span><span class="p">,</span> <span class="n">weeks</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">12</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ## Study cell formation</span>

<span class="sd">    Set `config.full_exp=True` to get the energy-dependent exposure. Code that does is in `exposure.sc_data_selection`</span>

<span class="sd">    Load first 4 weeks.</span>

<span class="sd">    ### Load data</span>
<span class="sd">    {out1}</span>
<span class="sd">    {fig}</span>
<span class="sd">    {out2}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">cells</span>
    
    <span class="k">with</span> <span class="n">capture_hide</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;setup: load </span><span class="si">{</span><span class="n">weeks</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">weeks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s1"> weeks of data for source &quot;</span><span class="si">{</span><span class="n">source_name</span><span class="si">}</span><span class="s1">&quot;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out1</span><span class="p">:</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">PointSource</span><span class="p">(</span><span class="n">source_name</span><span class="p">)</span> <span class="c1">#&#39;Geminga&#39;)</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="n">CellData</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">Config</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">week_range</span><span class="o">=</span><span class="n">weeks</span><span class="p">,</span><span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">cells</span><span class="o">.</span><span class="n">plot_concatenated</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">source_name</span><span class="p">);</span>
    <span class="k">with</span> <span class="n">capture_show</span><span class="p">(</span><span class="s1">&#39;Parmeters from Poisson fit to full data set&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out2</span><span class="p">:</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">cells</span><span class="o">.</span><span class="n">full_likelihood</span><span class="p">()</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="n">PoissonRep</span><span class="p">(</span><span class="n">L</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">pr</span><span class="o">.</span><span class="n">info</span><span class="p">()))</span>
    <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>
<span class="n">load_cell_data</span><span class="p">(</span><span class="n">use_kerr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">full_exp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Study-cell-formation">Study cell formation<a class="anchor-link" href="#Study-cell-formation"> </a></h2><p>Set <code>config.full_exp=True</code> to get the energy-dependent exposure. Code that does is in <code>exposure.sc_data_selection</code></p>
<p>Load first 4 weeks.</p>
<h3 id="Load-data">Load data<a class="anchor-link" href="#Load-data"> </a></h3><p><details  class="nbdoc-description" >  <summary> setup: load 4 weeks of data for source "Geminga" </summary>  <div style="margin-left: 5%;"><pre>SourceData:  4FGL J0633.9+1746<br>LoadData: Loading weeks[9:12:]   Processing 4 week files<br><br>....SourceData: Source 4FGL J0633.9+1746 with:<br>    data:         6,148 photons from 2008-08-04 to 2008-08-27<br>   exposure:    14,836 intervals,  average effective area 3174 cm^2 for 0.4 Ms<br>     rates:  source 3.30e-06/s, background 1.07e-06/s, TS 2290923.9<br>CellData.rebin: Bin photon data into 3 1-week bins from 54683.0 to 54704.0<br></pre></div> </details></p>
<p><figure style="margin-left: 5%" title="Figure 1">  <a href="images/load_cell_data_fig_01.png" title="images/load_cell_data_fig_01.png">    <img src="images/load_cell_data_fig_01.png" alt="Figure 1 at images/load_cell_data_fig_01.png" >   </a> </figure></p>
<p><details open class="nbdoc-description" >  <summary> Parmeters from Poisson fit to full data set </summary>  <div style="margin-left: 5%;"><pre>flux                      1.0<br>ts                    13396.4<br>errors    (1.69e-02, -0.0168)<br>limit                  1.0281<br>dtype: object<br></pre></div> </details></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary data-open="Hide Code" data-close="Show Code"></summary>
        <summary></summary>
        <div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nd">@ipynb_doc</span>
<span class="k">def</span> <span class="nf">check_energy_exposure</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; ### Exposure vs. energy</span>
<span class="sd">    </span>
<span class="sd">    With the {name} data, </span>
<span class="sd">    {out1}</span>
<span class="sd">    {out2}</span>
<span class="sd">    Note the `exp_fract` values, which are the fraction of the total (`exp`) in each band.</span>
<span class="sd">    {fig}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">cells</span><span class="o">.</span><span class="n">exposure</span>
    <span class="n">name</span> <span class="o">=</span><span class="n">cells</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">name</span>
    <span class="k">with</span> <span class="n">capture_show</span><span class="p">(</span><span class="s1">&#39;Exposure Dataframe from &quot;df.iloc[0]&quot;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">with</span> <span class="n">capture_hide</span><span class="p">(</span><span class="s1">&#39;Exposure dataframe info&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out2</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
    
    <span class="c1"># generate array of the 8 </span>
    <span class="n">t</span> <span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">exp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">exp_fract</span><span class="p">),</span> <span class="nb">float</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

    <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ax2</span><span class="p">,)</span> <span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Exposure vs. Energy&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;o&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Energy band&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Total Exposure&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">showmeans</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Exposure per interval&#39;</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Energy band index&#39;</span><span class="p">)</span>


    <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>
<span class="n">check_energy_exposure</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="Exposure-vs.-energy">Exposure vs. energy<a class="anchor-link" href="#Exposure-vs.-energy"> </a></h3><p>With the 4FGL J0633.9+1746 data,</p>
<p><details open class="nbdoc-description" >  <summary> Exposure Dataframe from "df.iloc[0]" </summary>  <div style="margin-left: 5%;"><pre>start                                             54682.656038<br>stop                                              54682.656375<br>livetime                                             25.041281<br>cos_theta                                             0.818114<br>exp                                                108394.3125<br>exp_fract    [0.1093, 0.135, 0.2428, 0.2141, 0.1603, 0.0918...<br>Name: 0, dtype: object<br></pre></div> </details></p>
<p><details  class="nbdoc-description" >  <summary> Exposure dataframe info </summary>  <div style="margin-left: 5%;"><pre>&lt;class 'pandas.core.frame.DataFrame'&gt;<br>RangeIndex: 14836 entries, 0 to 14835<br>Data columns (total 6 columns):<br> #   Column     Non-Null Count  Dtype  <br>---  ------     --------------  -----  <br> 0   start      14836 non-null  float64<br> 1   stop       14836 non-null  float64<br> 2   livetime   14836 non-null  float32<br> 3   cos_theta  14836 non-null  float32<br> 4   exp        14836 non-null  float32<br> 5   exp_fract  14836 non-null  object <br>dtypes: float32(3), float64(2), object(1)<br>memory usage: 521.7+ KB<br>None<br></pre></div> </details>
Note the <code>exp_fract</code> values, which are the fraction of the total (<code>exp</code>) in each band.</p>
<figure style="margin-left: 5%" title="Figure 2">  <a href="images/check_energy_exposure_fig_02.png" title="images/check_energy_exposure_fig_02.png">    <img src="images/check_energy_exposure_fig_02.png" alt="Figure 2 at images/check_energy_exposure_fig_02.png" >   </a> </figure>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<details class="description">
      <summary data-open="Hide Code" data-close="Show Code"></summary>
        <summary></summary>
        <div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nd">@ipynb_doc</span>
<span class="k">def</span> <span class="nf">flux_energy</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ### Weight sum vs. energy</span>
<span class="sd">    The sum of weights is proportional to the flux.</span>
<span class="sd">    Exmamine the photon energy dependence for {nickname}.</span>
<span class="sd">    </span>
<span class="sd">    {out1}</span>
<span class="sd">    {fig1}</span>
<span class="sd">    </span>
<span class="sd">    ### Check flux per energy band</span>
<span class="sd">    Make the ratio of the sum of weights to exposure, a measure of the flux relative to the spectrum.</span>
<span class="sd">    {out2}</span>
<span class="sd">    </span>
<span class="sd">    {fig2}</span>
<span class="sd">    Loods pretty good.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">cells</span><span class="o">.</span><span class="n">photons</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">name</span><span class="p">,</span> <span class="n">nickname</span> <span class="o">=</span> <span class="n">cells</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cells</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">nickname</span>
    <span class="k">with</span> <span class="n">capture_hide</span><span class="p">(</span><span class="s1">&#39;Photon dataframe info&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">info</span><span class="p">())</span>
    <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;eindex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">band</span><span class="o">.</span><span class="n">values</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="c1"># plt.subplots_adjust(wspace=0.3)</span>
    <span class="c1"># ax.hist(df.eindex, np.linspace(-0.5,7.5,9), log=False, histtype=&#39;step&#39;, lw=2);</span>
    <span class="c1"># ax.set(xlabel=&#39;Energy index&#39;, ylim=(2,None));</span>
    
    <span class="c1"># get the moments of the weight per energy</span>
    <span class="n">gb</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;eindex&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
            <span class="n">wcount</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">),</span>
            <span class="n">wsum</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">),</span> <span class="c1">#column=&quot;B&quot;, aggfunc=&quot;min&quot;</span>
            <span class="n">wsumsq</span> <span class="o">=</span><span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="n">gb</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">&#39;unc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gb</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">wsumsq</span><span class="p">)</span><span class="o">/</span><span class="n">r</span><span class="o">.</span><span class="n">wsum</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># wtsums = gb.sum().weight.values</span>

    <span class="n">fig1</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>

    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">gb</span><span class="o">.</span><span class="n">wsum</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;weight sum&#39;</span><span class="p">);</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">gb</span><span class="o">.</span><span class="n">wcount</span><span class="p">,</span> <span class="s1">&#39;D&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;counts&#39;</span><span class="p">);</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Energy band index&#39;</span><span class="p">,</span> <span class="n">yscale</span><span class="o">=</span><span class="s1">&#39;log&#39;</span><span class="p">);</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span> <span class="n">ax1</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    
    <span class="c1"># get exposure vs enegy</span>
    <span class="n">t</span> <span class="o">=</span><span class="n">cells</span><span class="o">.</span><span class="n">exposure</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">exp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">exp_fract</span><span class="p">),</span> <span class="nb">float</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
    <span class="n">ee</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-6</span>
    <span class="k">with</span> <span class="n">capture_hide</span><span class="p">(</span><span class="s1">&#39;Table of weights and Total exposure per band&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out2</span><span class="p">:</span>
        <span class="n">dfx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">wtsum</span><span class="o">=</span><span class="n">gb</span><span class="o">.</span><span class="n">wsum</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">exp</span><span class="o">=</span><span class="n">ee</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">ratio</span><span class="o">=</span><span class="p">(</span><span class="n">gb</span><span class="o">.</span><span class="n">wsum</span><span class="o">/</span><span class="n">ee</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">dfx</span><span class="p">)</span>
   
        
    <span class="n">fig2</span><span class="p">,</span> <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span> <span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Energy band index&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;flux/exposure&#39;</span><span class="p">)</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ratio</span> <span class="o">=</span> <span class="n">gb</span><span class="o">.</span><span class="n">wsum</span><span class="o">/</span><span class="n">ee</span>
    <span class="n">ax2</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ratio</span><span class="p">)),</span> <span class="n">y</span><span class="o">=</span><span class="n">ratio</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">ratio</span><span class="o">*</span><span class="n">gb</span><span class="o">.</span><span class="n">unc</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">ms</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="c1"># ax2.plot(gb.wsum/ee, &#39;o&#39;);</span>
    
    <span class="k">return</span> <span class="nb">locals</span><span class="p">()</span>
<span class="n">flux_energy</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

    </details>
<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="Weight-sum-vs.-energy">Weight sum vs. energy<a class="anchor-link" href="#Weight-sum-vs.-energy"> </a></h3><p>The sum of weights is proportional to the flux.
Exmamine the photon energy dependence for PSR J0633+1746.</p>
<p><details  class="nbdoc-description" >  <summary> Photon dataframe info </summary>  <div style="margin-left: 5%;"><pre>&lt;class 'pandas.core.frame.DataFrame'&gt;<br>RangeIndex: 6148 entries, 0 to 6147<br>Data columns (total 4 columns):<br> #   Column  Non-Null Count  Dtype   <br>---  ------  --------------  -----   <br> 0   band    6148 non-null   uint8   <br> 1   run_id  6148 non-null   category<br> 2   time    6148 non-null   float64 <br> 3   weight  6148 non-null   float64 <br>dtypes: category(1), float64(2), uint8(1)<br>memory usage: 124.5 KB<br>None<br></pre></div> </details></p>
<figure style="margin-left: 5%" title="Figure 3">  <a href="images/flux_energy_fig_03.png" title="images/flux_energy_fig_03.png">    <img src="images/flux_energy_fig_03.png" alt="Figure 3 at images/flux_energy_fig_03.png" >   </a> </figure><h3 id="Check-flux-per-energy-band">Check flux per energy band<a class="anchor-link" href="#Check-flux-per-energy-band"> </a></h3><p>Make the ratio of the sum of weights to exposure, a measure of the flux relative to the spectrum.</p>
<p><details  class="nbdoc-description" >  <summary> Table of weights and Total exposure per band </summary>  <div style="margin-left: 5%;"><pre>         wtsum    exp  ratio<br>eindex                      <br>0        458.8  143.9   3.19<br>1        580.7  181.6   3.20<br>2       1121.4  344.2   3.26<br>3        980.8  307.7   3.19<br>4        810.4  231.3   3.50<br>5        448.9  131.8   3.41<br>6        182.6   52.9   3.45<br>7         60.9   14.1   4.33<br></pre></div> </details></p>
<p><figure style="margin-left: 5%" title="Figure 4">  <a href="images/flux_energy_fig_04.png" title="images/flux_energy_fig_04.png">    <img src="images/flux_energy_fig_04.png" alt="Figure 4 at images/flux_energy_fig_04.png" >   </a> </figure>
Loods pretty good.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

